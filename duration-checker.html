<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YouTube Duration Checker</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #121212;
            color: #fff;
            padding: 40px 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        h1 {
            font-size: 32px;
            margin-bottom: 10px;
        }

        .subtitle {
            color: #b3b3b3;
            margin-bottom: 30px;
        }

        .controls {
            margin-bottom: 30px;
            display: flex;
            gap: 10px;
            align-items: center;
        }

        button {
            background: #1db954;
            color: #fff;
            border: none;
            padding: 12px 24px;
            border-radius: 500px;
            font-weight: 700;
            cursor: pointer;
            font-size: 14px;
        }

        button:hover {
            background: #1ed760;
            transform: scale(1.04);
        }

        button:disabled {
            background: #535353;
            cursor: not-allowed;
            transform: none;
        }

        .threshold-input {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        input[type="number"] {
            background: #282828;
            border: 1px solid #535353;
            color: #fff;
            padding: 8px 12px;
            border-radius: 4px;
            width: 80px;
        }

        .progress {
            background: #282828;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }

        .progress.active {
            display: block;
        }

        .progress-bar {
            height: 4px;
            background: #535353;
            border-radius: 2px;
            overflow: hidden;
            margin-top: 10px;
        }

        .progress-fill {
            height: 100%;
            background: #1db954;
            transition: width 0.3s;
        }

        .results {
            margin-top: 30px;
        }

        .playlist-result {
            background: #181818;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 16px;
        }

        .playlist-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .playlist-name {
            font-size: 18px;
            font-weight: 700;
        }

        .status {
            padding: 4px 12px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
        }

        .status.success {
            background: #1db954;
            color: #000;
        }

        .status.warning {
            background: #ffa600;
            color: #000;
        }

        .mismatch {
            background: #282828;
            padding: 12px;
            border-radius: 4px;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .track-name {
            font-weight: 600;
            margin-bottom: 4px;
        }

        .duration-info {
            color: #b3b3b3;
            font-size: 13px;
        }

        .duration-info span {
            color: #fff;
        }

        .summary {
            background: #282828;
            padding: 24px;
            border-radius: 8px;
            margin-top: 30px;
            display: none;
        }

        .summary.active {
            display: block;
        }

        .summary h2 {
            margin-bottom: 16px;
        }

        .stat-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
        }

        .stat {
            background: #181818;
            padding: 16px;
            border-radius: 4px;
        }

        .stat-value {
            font-size: 32px;
            font-weight: 700;
            color: #1db954;
        }

        .stat-label {
            color: #b3b3b3;
            font-size: 14px;
            margin-top: 4px;
        }

        #ytPlayerContainer {
            position: fixed;
            top: -9999px;
            left: -9999px;
        }

        .error {
            background: #e22134;
            color: #fff;
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ðŸŽµ YouTube Duration Checker</h1>
        <p class="subtitle">Validate that YouTube videos match Spotify track durations</p>

        <div class="controls">
            <button id="startBtn" onclick="startValidation()">Start Validation</button>
            <div class="threshold-input">
                <label>Threshold:</label>
                <input type="number" id="thresholdInput" value="10" min="1" max="60">
                <span>seconds</span>
            </div>
        </div>

        <div class="progress" id="progress">
            <div id="progressText">Checking tracks...</div>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
        </div>

        <div class="results" id="results"></div>

        <div class="summary" id="summary">
            <h2>Summary</h2>
            <div class="stat-grid" id="statsGrid"></div>
        </div>
    </div>

    <div id="ytPlayerContainer"></div>

    <script src="https://www.youtube.com/iframe_api"></script>
    <script>
        let ytPlayer;
        let isPlayerReady = false;

        // YouTube IFrame API callback
        function onYouTubeIframeAPIReady() {
            ytPlayer = new YT.Player('ytPlayerContainer', {
                height: '1',
                width: '1',
                events: {
                    'onReady': () => { isPlayerReady = true; }
                }
            });
        }

        // Parse CSV
        function parseCSV(csvText) {
            const lines = csvText.split('\n').filter(line => line.trim());
            const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
            const rows = [];

            for (let i = 1; i < lines.length; i++) {
                const values = [];
                let current = '';
                let inQuotes = false;

                for (let char of lines[i]) {
                    if (char === '"') {
                        inQuotes = !inQuotes;
                    } else if (char === ',' && !inQuotes) {
                        values.push(current.trim().replace(/^"|"$/g, ''));
                        current = '';
                    } else {
                        current += char;
                    }
                }
                values.push(current.trim().replace(/^"|"$/g, ''));

                if (values.length === headers.length) {
                    const row = {};
                    headers.forEach((header, idx) => {
                        row[header] = values[idx];
                    });
                    rows.push(row);
                }
            }

            return rows;
        }

        // Search YouTube (same logic as app.js)
        async function searchYouTube(trackName, artistName) {
            const cacheKey = `yt_${trackName}_${artistName}`;
            const cached = localStorage.getItem(cacheKey);
            if (cached) {
                return cached;
            }

            try {
                const query = encodeURIComponent(`${trackName} ${artistName} official audio`);
                const response = await fetch(`https://www.googleapis.com/youtube/v3/search?part=snippet&type=video&maxResults=1&q=${query}&key=YOUR_API_KEY`);
                const data = await response.json();

                if (data.items && data.items.length > 0) {
                    const videoId = data.items[0].id.videoId;
                    localStorage.setItem(cacheKey, videoId);
                    return videoId;
                }
            } catch (err) {
                console.error('Search error:', err);
            }

            return null;
        }

        // Get video duration using IFrame API
        async function getVideoDuration(videoId) {
            return new Promise((resolve) => {
                ytPlayer.loadVideoById(videoId);

                // Wait for video to load
                const checkDuration = setInterval(() => {
                    const duration = ytPlayer.getDuration();
                    if (duration > 0) {
                        clearInterval(checkDuration);
                        ytPlayer.stopVideo();
                        resolve(Math.round(duration));
                    }
                }, 100);

                // Timeout after 5 seconds
                setTimeout(() => {
                    clearInterval(checkDuration);
                    resolve(null);
                }, 5000);
            });
        }

        function formatDuration(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }

        async function validatePlaylist(playlistName, csvText, threshold) {
            const tracks = parseCSV(csvText);
            const mismatches = [];

            for (let i = 0; i < tracks.length; i++) {
                const track = tracks[i];
                const trackName = track['Track Name'];
                const artistName = track['Artist Name(s)'];
                const spotifyDurationMs = parseInt(track['Duration (ms)']);
                const spotifyDurationSec = Math.round(spotifyDurationMs / 1000);

                try {
                    const videoId = await searchYouTube(trackName, artistName);

                    if (!videoId) {
                        mismatches.push({
                            track: `${trackName} - ${artistName}`,
                            spotifyDuration: formatDuration(spotifyDurationSec),
                            youtubeDuration: 'Not found',
                            difference: 'N/A'
                        });
                        continue;
                    }

                    const youtubeDurationSec = await getVideoDuration(videoId);

                    if (!youtubeDurationSec) {
                        mismatches.push({
                            track: `${trackName} - ${artistName}`,
                            spotifyDuration: formatDuration(spotifyDurationSec),
                            youtubeDuration: 'Error loading',
                            difference: 'N/A'
                        });
                        continue;
                    }

                    const difference = Math.abs(spotifyDurationSec - youtubeDurationSec);

                    if (difference > threshold) {
                        mismatches.push({
                            track: `${trackName} - ${artistName}`,
                            spotifyDuration: formatDuration(spotifyDurationSec),
                            youtubeDuration: formatDuration(youtubeDurationSec),
                            difference: `${difference}s`
                        });
                    }
                } catch (err) {
                    console.error(`Error checking ${trackName}:`, err);
                }

                // Update progress
                const progress = ((i + 1) / tracks.length) * 100;
                updateProgress(playlistName, i + 1, tracks.length, progress);
            }

            return { mismatches, totalTracks: tracks.length };
        }

        function updateProgress(playlistName, current, total, percent) {
            document.getElementById('progressText').textContent =
                `Checking ${playlistName}: ${current}/${total} tracks`;
            document.getElementById('progressFill').style.width = `${percent}%`;
        }

        function displayResults(playlistName, result) {
            const resultsDiv = document.getElementById('results');
            const playlistDiv = document.createElement('div');
            playlistDiv.className = 'playlist-result';

            const statusClass = result.mismatches.length === 0 ? 'success' : 'warning';
            const statusText = result.mismatches.length === 0 ? 'âœ“ All match' : `âš  ${result.mismatches.length} issues`;

            playlistDiv.innerHTML = `
                <div class="playlist-header">
                    <div class="playlist-name">${playlistName}</div>
                    <div class="status ${statusClass}">${statusText}</div>
                </div>
            `;

            if (result.mismatches.length > 0) {
                const mismatchesHtml = result.mismatches.map(m => `
                    <div class="mismatch">
                        <div class="track-name">${m.track}</div>
                        <div class="duration-info">
                            Spotify: <span>${m.spotifyDuration}</span> |
                            YouTube: <span>${m.youtubeDuration}</span> |
                            Difference: <span>${m.difference}</span>
                        </div>
                    </div>
                `).join('');
                playlistDiv.innerHTML += mismatchesHtml;
            }

            resultsDiv.appendChild(playlistDiv);
        }

        function displaySummary(allResults) {
            const totalTracks = allResults.reduce((sum, r) => sum + r.totalTracks, 0);
            const totalMismatches = allResults.reduce((sum, r) => sum + r.mismatches.length, 0);
            const successRate = ((totalTracks - totalMismatches) / totalTracks * 100).toFixed(1);

            const statsGrid = document.getElementById('statsGrid');
            statsGrid.innerHTML = `
                <div class="stat">
                    <div class="stat-value">${totalTracks}</div>
                    <div class="stat-label">Total Tracks</div>
                </div>
                <div class="stat">
                    <div class="stat-value">${totalMismatches}</div>
                    <div class="stat-label">Duration Issues</div>
                </div>
                <div class="stat">
                    <div class="stat-value">${successRate}%</div>
                    <div class="stat-label">Success Rate</div>
                </div>
                <div class="stat">
                    <div class="stat-value">${allResults.length}</div>
                    <div class="stat-label">Playlists Checked</div>
                </div>
            `;

            document.getElementById('summary').classList.add('active');
        }

        async function startValidation() {
            if (!isPlayerReady) {
                alert('YouTube player is still loading. Please wait a moment and try again.');
                return;
            }

            const threshold = parseInt(document.getElementById('thresholdInput').value);
            const startBtn = document.getElementById('startBtn');
            const progressDiv = document.getElementById('progress');
            const resultsDiv = document.getElementById('results');
            const summaryDiv = document.getElementById('summary');

            startBtn.disabled = true;
            progressDiv.classList.add('active');
            resultsDiv.innerHTML = '';
            summaryDiv.classList.remove('active');

            const allResults = [];

            try {
                // Get list of CSV files from the csvs directory
                const playlistFiles = [
                    '70Â°_finally.csv', 'Aaroncore.csv', 'Avett_addiction_.csv',
                    // Add more playlist files here...
                    // For now, let's just test with a few
                ];

                for (const filename of playlistFiles) {
                    const playlistName = filename.replace(/_/g, ' ').replace('.csv', '');

                    try {
                        const response = await fetch(`/Users/aaronsmolyar/Documents/spotify_playlists/csvs/${filename}`);
                        const csvText = await response.text();

                        const result = await validatePlaylist(playlistName, csvText, threshold);
                        allResults.push({ playlistName, ...result });
                        displayResults(playlistName, result);
                    } catch (err) {
                        console.error(`Error loading ${playlistName}:`, err);
                    }
                }

                displaySummary(allResults);
            } finally {
                startBtn.disabled = false;
                progressDiv.classList.remove('active');
            }
        }
    </script>
</body>
</html>
